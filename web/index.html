<!DOCTYPE html>
<html>
  <head>
    <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
    <base href="$FLUTTER_BASE_HREF" />

    <meta charset="UTF-8" />
    <meta content="IE=Edge" http-equiv="X-UA-Compatible" />
    <meta name="description" content="A new Flutter project." />

    <!-- iOS meta tags & icons -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="crmMobileUi" />
    <link rel="apple-touch-icon" href="icons/Icon-192.png" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png" />

    <title>crmMobileUi</title>
    <link rel="manifest" href="manifest.json" />
  </head>
  <body>
    <!-- <script src="flutter_bootstrap.js" async></script> -->
    <script src="main.dart.js" type="application/javascript"></script>


<!-- âœ… MSAL.js -->
<script type="text/javascript" src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>

<!-- âœ… CRM MSAL Integration -->
<script>
  // Wrap everything inside an IIFE (immediately-invoked function)
  // to ensure `msalInstance` is initialized before it's used.
  (function () {
    console.log("âš™ï¸ Initializing MSAL...");

    const msalConfig = {
      auth: {
        clientId: "beb2c846-d811-4014-9479-00c6361b18e2",
        authority: "https://login.microsoftonline.com/9c822166-54c6-4c9c-b0eb-d390a8f54e66", // ðŸ‘ˆ single-tenant
        redirectUri: window.location.origin,
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: false,
      },
    };

    // âœ… Initialize MSAL
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    // âœ… Handle redirect promises (MSAL housekeeping)
    msalInstance
      .handleRedirectPromise()
      .then((resp) => {
        if (resp) {
          console.log("ðŸ”„ Redirect response:", resp);
        }
      })
      .catch((e) => console.warn("Redirect handling error:", e));

    // âœ… Expose functions globally to be called from Dart
    window.msalLogin = async function () {
      console.log("ðŸªŸ Starting MSAL web login...");

      const loginRequest = {
        scopes: [
          "api://beb2c846-d811-4014-9479-00c6361b18e2/access_as_user"
        ],
      };

      try {
        // ðŸ”¹ 1. Try existing session first
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) {
          console.log("âœ… Found existing account:", accounts[0].username);
          const silentResult = await msalInstance.acquireTokenSilent({
            ...loginRequest,
            account: accounts[0],
          });
          console.log("ðŸŽŸï¸ Silent token acquired.");
          return silentResult.accessToken ?? null;
        }

        // ðŸ”¹ 2. No existing session? Open popup
        console.log("ðŸªŸ Opening MSAL login popup...");
        const loginResponse = await msalInstance.loginPopup(loginRequest);
        console.log("âœ… Login successful:", loginResponse.account.username);

        // ðŸ”¹ 3. Acquire token silently
        const tokenResponse = await msalInstance.acquireTokenSilent({
          ...loginRequest,
          account: loginResponse.account,
        });

        // âœ… Close popup safely if running inside popup
        if (window.opener && window.opener !== window) {
          console.log("ðŸ”’ Closing popup window...");
          setTimeout(() => window.close(), 500);
        }

        if (tokenResponse && tokenResponse.accessToken) {
          console.log(
            "âœ… Token acquired:",
            tokenResponse.accessToken.substring(0, 20) + "..."
          );
          return tokenResponse.accessToken;
        } else {
          console.warn("âš ï¸ No access token found in response");
          return null;
        }
      } catch (err) {
        console.error("âŒ MSAL Login Error:", err);

        // Handle MFA / conditional access fallback
        if (err.errorCode === "interaction_required") {
          try {
            const popupResponse = await msalInstance.loginPopup(loginRequest);
            const tokenResponse = await msalInstance.acquireTokenSilent({
              ...loginRequest,
              account: popupResponse.account,
            });
            if (window.opener && window.opener !== window) {
              console.log("ðŸ”’ Closing popup window (fallback)...");
              setTimeout(() => window.close(), 500);
            }
            return tokenResponse.accessToken ?? null;
          } catch (popupErr) {
            console.error("âŒ Popup login failed:", popupErr);
          }
        }

        return null;
      }
    };

    window.webAzureLogout = function () {
      try {
        msalInstance.logoutPopup().then(() => {
          localStorage.clear();
          sessionStorage.clear();
          console.log("âœ… Logged out and cleared cache");
        });
      } catch (e) {
        console.error("Logout error:", e);
      }
    };
  })();
</script>







  </body>
</html>
